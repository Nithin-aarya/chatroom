<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Chat Room</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #000; overflow: hidden; }
    #canvas { width: 100vw; height: 100vh; }
    #ui { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; z-index: 10; }
    #chat { position: absolute; bottom: 20px; left: 20px; width: 400px; height: 200px; background: rgba(0,0,0,0.9); border-radius: 10px; display: flex; flex-direction: column; z-index: 10; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; color: white; font-size: 14px; }
    #input-area { padding: 10px; border-top: 1px solid #444; display: flex; gap: 10px; }
    #chat-input { flex: 1; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid #666; border-radius: 5px; color: white; }
    #send-btn { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
    #modes { position: absolute; top: -35px; left: 0; display: flex; gap: 5px; }
    .mode-btn { background: rgba(0,0,0,0.8); color: white; border: 1px solid #666; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; }
    .mode-btn.active { background: #007bff; }
    #users { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 10px; z-index: 10; }
    #username-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 100; }
    #username-form { background: white; padding: 30px; border-radius: 15px; text-align: center; }
    #username-input { width: 200px; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
    #username-submit { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    .message { margin: 5px 0; padding: 5px 8px; border-radius: 5px; }
    .message.normal { background: rgba(0,123,255,0.2); }
    .message.whisper { background: rgba(255,193,7,0.2); font-style: italic; }
    .message.private { background: rgba(220,53,69,0.2); }
    .message.faded { opacity: 0.4; }
    .username { font-weight: bold; margin-right: 5px; }
    #sit-prompt { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; display: none; }
  </style>
</head>
<body>
  <div id="username-modal">
    <div id="username-form">
      <h2>Join 3D Chat</h2>
      <input type="text" id="username-input" placeholder="Your username...">
      <br><button id="username-submit">Join</button>
      <p style="font-size: 12px; color: #666;">WASD to move, mouse to look, E to sit</p>
    </div>
  </div>

  <div id="canvas"></div>

  <div id="ui">
    <h3>3D Chat Room</h3>
    <p>üéÆ WASD: Move</p>
    <p>üñ±Ô∏è Mouse: Look</p>
    <p>ü™ë E: Sit/Stand</p>
    <p>üí¨ Distance Audio</p>
  </div>

  <div id="users">
    <h4>Online</h4>
    <div id="users-list"></div>
  </div>

  <div id="chat">
    <div id="modes">
      <button class="mode-btn active" data-mode="normal">Normal</button>
      <button class="mode-btn" data-mode="whisper">Whisper</button>
      <button class="mode-btn" data-mode="private">Private</button>
    </div>
    <div id="messages"></div>
    <div id="input-area">
      <input type="text" id="chat-input" placeholder="Type message...">
      <button id="send-btn">Send</button>
    </div>
  </div>

  <div id="sit-prompt">Press E to sit</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    let scene, camera, renderer, player, users = {}, currentUser, chatMode = 'normal';
    let chairs = [], nearbyChair = null, sitting = false, keys = {}, mouseX = 0;

    function init() {
      setupScene();
      createRoom();
      createChairs();
      setupUI();
      setupControls();
      animate();
    }

    function setupScene() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x2c3e50);
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.getElementById('canvas').appendChild(renderer.domElement);

      const light = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(light);
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.4);
      dirLight.position.set(10, 15, 10);
      scene.add(dirLight);
    }

    function createRoom() {
      const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(30, 30),
        new THREE.MeshLambertMaterial({ color: 0x34495e })
      );
      floor.rotation.x = -Math.PI / 2;
      scene.add(floor);

      const table = new THREE.Mesh(
        new THREE.BoxGeometry(6, 0.2, 3),
        new THREE.MeshLambertMaterial({ color: 0x8b4513 })
      );
      table.position.set(0, 0.9, 0);
      scene.add(table);
    }

    function createChairs() {
      const positions = [
        { x: 0, z: 3 }, { x: 0, z: -3 }, { x: -4, z: 0 }, { x: 4, z: 0 },
        { x: -3, z: 2 }, { x: 3, z: 2 }, { x: -3, z: -2 }, { x: 3, z: -2 }
      ];

      positions.forEach((pos, i) => {
        const chair = new THREE.Group();
        const seat = new THREE.Mesh(
          new THREE.BoxGeometry(0.8, 0.1, 0.8),
          new THREE.MeshLambertMaterial({ color: 0x654321 })
        );
        seat.position.y = 0.5;
        chair.add(seat);

        const back = new THREE.Mesh(
          new THREE.BoxGeometry(0.8, 0.6, 0.1),
          new THREE.MeshLambertMaterial({ color: 0x654321 })
        );
        back.position.set(0, 0.8, -0.35);
        chair.add(back);

        chair.position.set(pos.x, 0, pos.z);
        chair.userData = { id: i, occupied: false, pos: pos };
        chairs.push(chair);
        scene.add(chair);
      });
    }

    function setupUI() {
      const modal = document.getElementById('username-modal');
      const input = document.getElementById('username-input');
      const submit = document.getElementById('username-submit');
      const chatInput = document.getElementById('chat-input');
      const sendBtn = document.getElementById('send-btn');

      submit.onclick = () => {
        const name = input.value.trim();
        if (name) {
          currentUser = { name: name, color: Math.random() * 0xffffff };
          player = { pos: new THREE.Vector3(0, 1.6, 5), sitting: false };
          camera.position.copy(player.pos);
          modal.style.display = 'none';
          socket.emit("setUsername", name);
        }
      };

      input.onkeypress = (e) => e.key === 'Enter' && submit.click();

      sendBtn.onclick = () => {
        const msg = chatInput.value.trim();
        if (msg && currentUser) {
          socket.emit("chatMessage", msg);
          chatInput.value = '';
        }
      };

      chatInput.onkeypress = (e) => e.key === 'Enter' && sendBtn.click();

      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelector('.mode-btn.active').classList.remove('active');
          btn.classList.add('active');
          chatMode = btn.dataset.mode;
        };
      });
    }

    function setupControls() {
      document.onkeydown = (e) => {
        if (document.activeElement === document.getElementById('chat-input')) return;
        keys[e.key.toLowerCase()] = true;
        if (e.key.toLowerCase() === 'e' && nearbyChair) toggleSit();
      };

      document.onkeyup = (e) => {
        if (document.activeElement === document.getElementById('chat-input')) return;
        keys[e.key.toLowerCase()] = false;
      };

      document.onmousemove = (e) => {
        if (document.pointerLockElement === renderer.domElement) {
          mouseX += e.movementX * 0.002;
        }
      };

      renderer.domElement.onclick = () => renderer.domElement.requestPointerLock();
    }

    function updatePlayer() {
      if (sitting) return;
      const speed = 0.1;
      const vel = new THREE.Vector3(0, 0, 0);

      if (keys['w']) vel.z = speed;
      if (keys['s']) vel.z = -speed;
      if (keys['a']) vel.x = -speed;
      if (keys['d']) vel.x = speed;

      const forward = new THREE.Vector3(0, 0, -1);
      forward.applyQuaternion(camera.quaternion);
      forward.y = 0;
      forward.normalize();

      const right = new THREE.Vector3(1, 0, 0);
      right.applyQuaternion(camera.quaternion);
      right.y = 0;
      right.normalize();

      player.pos.add(forward.multiplyScalar(vel.z));
      player.pos.add(right.multiplyScalar(vel.x));

      player.pos.x = Math.max(-12, Math.min(12, player.pos.x));
      player.pos.z = Math.max(-12, Math.min(12, player.pos.z));

      camera.position.copy(player.pos);
      camera.rotation.y = mouseX;

      checkChairs();
    }

    function checkChairs() {
      nearbyChair = null;
      let minDist = 2;
      chairs.forEach(chair => {
        const dist = player.pos.distanceTo(chair.position);
        if (dist < minDist) {
          minDist = dist;
          nearbyChair = chair;
        }
      });

      const prompt = document.getElementById('sit-prompt');
      if (nearbyChair && !sitting) {
        prompt.style.display = 'block';
        prompt.textContent = nearbyChair.userData.occupied ? 'Chair occupied' : 'Press E to sit';
      } else if (sitting) {
        prompt.style.display = 'block';
        prompt.textContent = 'Press E to stand';
      } else {
        prompt.style.display = 'none';
      }
    }

    function toggleSit() {
      if (sitting) {
        sitting = false;
        player.pos.y = 1.6;
        if (player.chairId !== undefined) {
          chairs[player.chairId].userData.occupied = false;
        }
      } else if (nearbyChair && !nearbyChair.userData.occupied) {
        sitting = true;
        player.chairId = nearbyChair.userData.id;
        nearbyChair.userData.occupied = true;
        player.pos.x = nearbyChair.userData.pos.x;
        player.pos.z = nearbyChair.userData.pos.z;
        player.pos.y = 1.1;
      }
    }

    function addMessage(type, user, content = '') {
      const container = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = `message ${type}`;
      if (type === 'system') {
        div.innerHTML = `<em>${user}</em>`;
      } else {
        div.innerHTML = `<span class="username">${user}:</span> ${content}`;
      }
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      if (container.children.length > 30) {
        container.removeChild(container.children[0]);
      }
    }

    // --- SOCKET.IO INTEGRATION ---
    const socket = io();

    socket.on("chatMessage", ({ user, msg }) => {
      addMessage("normal", user, msg);
    });

    socket.on("userJoined", (name) => {
      addMessage("system", `${name} joined!`);
    });

    socket.on("userLeft", (name) => {
      addMessage("system", `${name} left!`);
    });

    function animate() {
      requestAnimationFrame(animate);
      if (player) updatePlayer();
      renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init();
  </script>
</body>
</html>
