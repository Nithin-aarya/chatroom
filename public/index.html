<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>3D Chatroom</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    #chat { position: absolute; bottom: 0; left: 0; width: 300px; height: 200px; background: rgba(0,0,0,0.6); color: white; overflow-y: auto; padding: 5px; }
    #chat-input { position: absolute; bottom: 0; left: 0; width: 240px; }
    #sendBtn { position: absolute; bottom: 0; left: 245px; }
    #users { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.6); color: white; padding: 10px; min-width: 150px; }
    #joinModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; }
    #joinBox { background: white; padding: 20px; border-radius: 8px; }
  </style>
</head>
<body>
  <div id="joinModal">
    <div id="joinBox">
      <h2>Join 3D Chat</h2>
      <input id="username" placeholder="Enter name" />
      <button id="joinBtn">Join</button>
    </div>
  </div>

  <div id="users"><b>Online:</b><div id="users-list"></div></div>
  <div id="chat"></div>
  <input id="chat-input" placeholder="Type message..." />
  <button id="sendBtn">Send</button>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script>
    const socket = io();
    let scene, camera, renderer;
    let avatars = {};
    let myId = null;
    let keys = {};

    // Init 3D
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    camera.position.set(0, 2, 5);

    function createAvatar(id, color) {
      const group = new THREE.Group();
      const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1.5), new THREE.MeshBasicMaterial({ color }));
      const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshBasicMaterial({ color }));
      head.position.y = 1;
      group.add(body);
      group.add(head);
      scene.add(group);
      avatars[id] = group;
    }

    function updateAvatars(users) {
      for (const id in users) {
        if (!avatars[id]) createAvatar(id, users[id].color);
        avatars[id].position.set(users[id].x, users[id].y, users[id].z);
      }
      for (const id in avatars) {
        if (!users[id]) {
          scene.remove(avatars[id]);
          delete avatars[id];
        }
      }
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
      if (myId && avatars[myId]) {
        let moved = false;
        const speed = 0.05;
        if (keys['w']) { avatars[myId].position.z -= speed; moved = true; }
        if (keys['s']) { avatars[myId].position.z += speed; moved = true; }
        if (keys['a']) { avatars[myId].position.x -= speed; moved = true; }
        if (keys['d']) { avatars[myId].position.x += speed; moved = true; }
        if (moved) {
          const pos = avatars[myId].position;
          socket.emit("move", { x: pos.x, y: pos.y, z: pos.z });
        }
      }
    }
    animate();

    // Normalize keys (Windows + Mac)
    function normalizeKey(e) {
      switch (e.key) {
        case "ArrowUp": return "w";
        case "ArrowDown": return "s";
        case "ArrowLeft": return "a";
        case "ArrowRight": return "d";
        default: return e.key.toLowerCase();
      }
    }
    window.addEventListener("keydown", (e) => {
      if (document.activeElement === document.getElementById("chat-input")) return;
      keys[normalizeKey(e)] = true;
    });
    window.addEventListener("keyup", (e) => {
      if (document.activeElement === document.getElementById("chat-input")) return;
      keys[normalizeKey(e)] = false;
    });

    // Chat
    document.getElementById("sendBtn").addEventListener("click", () => {
      const input = document.getElementById("chat-input");
      if (input.value.trim()) {
        socket.emit("chatMessage", input.value.trim());
        input.value = "";
      }
    });
    socket.on("chatMessage", ({ user, msg }) => {
      const chat = document.getElementById("chat");
      chat.innerHTML += `<div><b>${user}:</b> ${msg}</div>`;
      chat.scrollTop = chat.scrollHeight;
    });

    // Online users
    socket.on("updateUserList", (users) => {
      updateAvatars(users);
      const listDiv = document.getElementById("users-list");
      listDiv.innerHTML = "";
      for (const id in users) {
        listDiv.innerHTML += `<div>${users[id].name}</div>`;
      }
    });

    // Join button
    document.getElementById("joinBtn").addEventListener("click", () => {
      const name = document.getElementById("username").value.trim();
      if (!name) return;
      socket.emit("setUsername", name);
      myId = socket.id;
      document.getElementById("joinModal").style.display = "none";
    });
    document.getElementById("username").addEventListener("keypress", (e) => {
      if (e.key === "Enter") document.getElementById("joinBtn").click();
    });
  </script>
</body>
</html>
